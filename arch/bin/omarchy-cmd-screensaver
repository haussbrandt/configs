#!/bin/bash

screensaver_in_focus() {
	hyprctl activewindow -j | jq -e '.class == "Screensaver"' >/dev/null 2>&1
}

exit_screensaver() {
	hyprctl keyword cursor:invisible false
	pkill -x tte 2>/dev/null
	pkill -f "alacritty --class Screensaver" 2>/dev/null
	exit 0
}

trap exit_screensaver SIGINT SIGTERM SIGHUP SIGQUIT

hyprctl keyword cursor:invisible true

while true; do
	tte -i ~/.config/screensaver.txt \
		--frame-rate 240 --canvas-width 0 --canvas-height 0 --reuse-canvas --anchor-canvas c --anchor-text c \
		--random-effect --exclude-effects dev_worm --no-eol --no-restore-cursor &

	while pgrep -x tte >/dev/null; do
		if read -n 1 -t 3 || ! screensaver_in_focus; then
			exit_screensaver
		fi
	done
done
